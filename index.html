<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Starry profile (Dream)</title>
  <style>
    /* live 2d */
    /* Live2D container: use responsive dimensions (vw/vh) + limits, adapt to various screens */
  #l2d-container{
    position: fixed;
    right: 12px;
    bottom: 12px;
    top: 12px;             
    z-index: 9;
    pointer-events: auto;
    width: clamp(260px, 42vw, 520px); 

  }


    /* Canvas always fills container, don't hardcode pixels like 260x360 anymore */
    #l2d-container canvas{
      width: 100% !important;
      height: 100% !important;
      display: block;
      pointer-events: auto;
    }

    /* Tighter margins on small screens (optional) */
    @media (max-width: 640px){
      #l2d-container{ right: 6px; bottom: 6px; }
    }


    /* ------- Background Canvas ------- */
    #space {
      position: fixed;
      inset: 0; /* top/right/bottom/left: 0 */
      width: 100%;
      height: 100%;
      z-index: -2; /* behind everything */
      display: block;
    }
    /* A subtle overlay to improve text contrast */
    .bg-overlay {
      position: fixed; inset: 0; z-index: -1; pointer-events: none;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(59,130,246,0.20), transparent 60%),
        radial-gradient(800px 400px at 90% 110%, rgba(236,72,153,0.14), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.22), rgba(0,0,0,0.45));
    }

    /* ------- Layout ------- */
    .page { max-width: 980px; margin: 0 auto; padding: 24px 16px 96px; }
    header.site {
      position: sticky; top: 0; backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(2,6,23,0.65), rgba(2,6,23,0));
      border-bottom: 1px solid rgba(255,255,255,0.06);
      z-index: 10;
    }
    .nav { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px 0; }
    .brand { font-weight: 700; letter-spacing: 0.4px; color: #fff; }
    .links { display: flex; gap: 12px; flex-wrap: wrap; }
    .links a { color: #cbd5e1; text-decoration: none; padding: 6px 10px; border-radius: 10px; border: 1px solid transparent; }
    .links a:hover { color: #fff; border-color: rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); }

    /* ------- Card / Sections ------- */
    .card {
      background: rgba(15,23,42,0.35); /* slate-900 @ 55% */
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px; box-shadow: 0 12px 40px rgba(0,0,0,0.45);
      backdrop-filter: blur(8px);
    }
    .hero { display: grid; grid-template-columns: 140px 1fr; gap: 18px; align-items: center; padding: 18px; }
    .avatar {
      width: 140px; height: 140px; border-radius: 999px; overflow: hidden; border: 2px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, #0b1020, #1f2937);
      display: grid; place-items: center; font-weight: 700; font-size: 38px; color: #94a3b8;
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }

    h1 { font-size: 28px; color: #fff; }
    .muted { color: #cbd5e1; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .btn { cursor: pointer; text-decoration: none; border-radius: 999px; padding: 10px 14px; border: 1px solid #334155; background: rgba(30,58,138,0.45); color: #fff; }
    .btn:hover { filter: brightness(1.06); }

    section { margin-top: 22px; }
    section > .card { padding: 18px; }
    section h2 { font-size: 18px; margin-bottom: 12px; color: #fff; letter-spacing: 0.3px; }

    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { padding: 6px 10px; border-radius: 999px; background: rgba(148,163,184,0.15); border: 1px solid rgba(148,163,184,0.25); color: #e2e8f0; font-size: 13px; }

    .projects { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
    .project { padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); background: rgba(2,6,23,0.35); }
    .project h3 { font-size: 16px; color: #fff; margin-bottom: 4px; }
    .project p { color: #cbd5e1; font-size: 14px; }

    footer { opacity: 0.7; text-align: center; padding: 28px 0 40px; font-size: 13px; }

    /* ------- Small helper for section spacing on mobile ------- */
    @media (max-width: 640px) {
      .hero { grid-template-columns: 1fr; text-align: center; }
      .avatar { margin: 0 auto; }
      .links { justify-content: center; }
    }

    /* ------- Reduce Motion Preference ------- */
    @media (prefers-reduced-motion: reduce) {
      .hint-motion { display: none; }
      .zzz, .dream-bubble { animation: none !important; }
    }
  
    /* ------- Live2D (widget) positioning ------- */
    /* The widget library injects a canvas; we pin it bottom-right and keep clicks passing through */
    #live2d-widget, #live2dcanvas {
      position: fixed; right: 12px; bottom: 12px; z-index: 9;
      pointer-events: auto; /* so it won't block page links; remove if you want interactions */
    }
    @media (max-width: 640px) {
      #live2d-widget, #live2dcanvas { transform: scale(0.85); transform-origin: 100% 100%; }
    }
  
    /* ===================== SLEEP SCENE (new) ===================== */
    .sleep-card { position: relative; overflow: hidden; }
    #sleep-scene {
      position: relative;
      height: 220px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,0.12);
      background:
        radial-gradient(600px 300px at 20% -20%, rgba(59,130,246,0.25), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.85));
      display: grid;
      place-items: center;
      isolation: isolate;
    }
    .bed {
      position: absolute; bottom: 24px; left: 26px; right: 26px; height: 110px;
      border-radius: 16px; background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148,163,184,0.15);
      box-shadow: inset 0 4px 24px rgba(0,0,0,0.35);
    }
    .pillow {
      position: absolute; right: 40px; bottom: 120px; width: 90px; height: 40px;
      background: #e2e8f0; border-radius: 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }
    .sleeper {
      position: absolute; right: 78px; bottom: 132px; width: 52px; height: 52px; border-radius: 50%;
      background: linear-gradient(180deg,#fecdd3,#fda4af);
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
    }
    .blanket {
      position: absolute; right: 36px; bottom: 94px; width: 210px; height: 80px;
      background: linear-gradient(180deg, rgba(59,130,246,0.55), rgba(37,99,235,0.75));
      border-radius: 18px 18px 12px 12px; border: 1px solid rgba(96,165,250,0.35);
      transform-origin: 0% 100%;
      animation: breathe 4s ease-in-out infinite;
    }
    @keyframes breathe {
      0%,100% { transform: translateY(0) rotate(-1deg); }
      50% { transform: translateY(4px) rotate(1deg); }
    }

    .zzz { position: absolute; right: 24px; bottom: 180px; font-weight: 700; color: #cbd5e1; opacity: 0.9; }
    .zzz span { position: absolute; font-size: 14px; animation: floatZ 3s linear infinite; }
    .zzz span:nth-child(2){ animation-delay: .8s; transform: translate(10px, 0) scale(1.2); }
    .zzz span:nth-child(3){ animation-delay: 1.6s; transform: translate(20px, 0) scale(1.4); }
    @keyframes floatZ { 0%{ transform: translate(0,0); opacity:.85 } 100%{ transform: translate(0,-40px); opacity:0 } }

    .dream-bubble {
      --size: 76px;
      position: absolute; left: 24px; bottom: 120px; width: var(--size); height: var(--size); border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
      box-shadow: 0 10px 24px rgba(2,6,23,0.45), inset 0 0 20px rgba(147,197,253,0.65);
      display: grid; place-items: center; cursor: pointer; z-index: 2;
      animation: bob 3.6s ease-in-out infinite;
    }
    .dream-bubble::after { /* small bubble */
      content: ""; position: absolute; right: -14px; bottom: -14px; width: 18px; height: 18px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(255,255,255,0.6));
      box-shadow: inset 0 0 10px rgba(147,197,253,0.45);
    }
    @keyframes bob { 0%,100%{ transform: translateY(0) } 50%{ transform: translateY(8px)} }
    .dream-bubble span { font-size: 12px; color: #0f172a; font-weight: 700; letter-spacing: .6px; text-transform: uppercase; }

    .hint { position: absolute; left: 20px; bottom: 18px; color: #cbd5e1; font-size: 12px; opacity: .9; }
    .hint kbd{ background: rgba(148,163,184,0.18); border:1px solid rgba(148,163,184,0.35); padding: 2px 6px; border-radius:8px; }

    /* ===================== DREAM OVERLAY (portal) ===================== */

    .dream-wrap{ max-width: 1080px; margin: 0 auto; padding: 32px 16px 56px; }
    .dream-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 20px; }
    .dream-title{ font-size: 28px; color:#fff; letter-spacing:.4px; }
    .close-btn{ cursor:pointer; border-radius:999px; border:1px solid rgba(148,163,184,0.35); padding:8px 12px; background: rgba(30,41,59,0.55); color:#fff; }
    .close-btn:hover{ filter:brightness(1.05) }

    .dream-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:14px; }
    .dream-card{ padding:14px; border-radius:12px; background: rgba(15,23,42,0.55); border:1px solid rgba(148,163,184,0.2); }
    .dream-card h3{ color:#fff; font-size:16px; margin-bottom:6px; }
    .dream-card p{ color:#cbd5e1; font-size:14px; }

    .dream-tip{ margin: 8px 0 16px; font-size: 13px; color: #cbd5e1; opacity:.9 }
      /* ============== INTRO (start screen) ============== */
    #intro{ position:fixed; inset:0; z-index:50; pointer-events:none; }
    .intro-wrap{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(960px, 92vw); pointer-events:auto; }
    .intro-card{ position:relative; padding:20px; border-radius:18px; background:rgba(15,23,42,0.35); border:1px solid rgba(148,163,184,0.25); backdrop-filter: blur(8px); box-shadow:0 20px 60px rgba(0,0,0,0.45); }
    .sleep-stage{ position:relative; height:320px; border-radius:14px; border:1px dashed rgba(255,255,255,0.12); background: radial-gradient(600px 300px at 20% -20%, rgba(59,130,246,0.18), transparent 60%); overflow:hidden; isolation:isolate; }
    .bed{ position:absolute; left:28px; right:28px; bottom:28px; height:140px; border-radius:16px; background:rgba(15,23,42,0.85); border:1px solid rgba(148,163,184,0.15); box-shadow:inset 0 4px 24px rgba(0,0,0,0.35); }
    .pillow{ position:absolute; right:56px; bottom:178px; width:110px; height:46px; background:#e2e8f0; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,0.25); }
    .sleeper{ position:absolute; right:98px; bottom:194px; width:60px; height:60px; border-radius:999px; background:linear-gradient(180deg,#fecdd3,#fda4af); box-shadow:0 6px 20px rgba(0,0,0,0.35); }
    .blanket{ position:absolute; right:44px; bottom:126px; width:260px; height:96px; background:linear-gradient(180deg, rgba(59,130,246,0.55), rgba(37,99,235,0.75)); border-radius:18px 18px 12px 12px; border:1px solid rgba(96,165,250,0.35); transform-origin:0% 100%; animation:breathe 4s ease-in-out infinite; }
    .zzz{ position:absolute; right:28px; bottom:240px; font-weight:700; color:#cbd5e1; opacity:.9 }
    .zzz span{ position:absolute; font-size:16px; animation: floatZ 3s linear infinite; }
    .zzz span:nth-child(2){ animation-delay:.8s; transform: translate(10px,0) scale(1.2)}
    .zzz span:nth-child(3){ animation-delay:1.6s; transform: translate(20px,0) scale(1.4)}

    .dream-window{ position:absolute; left:40px; top:34px; width:120px; height:120px; border-radius:999px; overflow:hidden; box-shadow:0 8px 24px rgba(2,6,23,0.5), inset 0 0 28px rgba(147,197,253,0.6); border:1px solid rgba(147,197,253,0.45); display:grid; place-items:center; }
  #dream-sky,
  #dream-sky-fab{
    width: 100%;
    height: 100%;
    display: block;
    transform: none;
  }

  .dream-window canvas{
    border-radius: 50%;
  }

    .enter-btn{ position:absolute; left:40px; top:170px; border-radius:999px; padding:10px 14px; border:1px solid rgba(148,163,184,0.35); background:rgba(30,41,59,0.6); color:#fff; cursor:pointer }
    .enter-btn:hover{ filter:brightness(1.06) }

    /* Simple fade */
    .fade-out{ animation: fadeOut .6s ease forwards }
    @keyframes fadeOut{ to{ opacity:0; visibility:hidden } }

    /* ---- Do not dim starfield while sleeping (intro mode) ---- */
    body[data-mode="intro"] .bg-overlay{ display:none; }
    body[data-mode="intro"] #intro .intro-card{ background: transparent; border: none; box-shadow: none; backdrop-filter: none; }
    body[data-mode="intro"] #intro .sleep-stage{ background: transparent; }
    body[data-mode="intro"] #intro .sleep-stage .bed{ background: rgba(15,23,42,0.7); }
    body[data-mode="intro"] #intro .sleep-stage .blanket{ background: linear-gradient(180deg, rgba(59,130,246,0.45), rgba(37,99,235,0.6)); }
    /* ===== Circular reveal mask for dream transition ===== */
    #dream-reveal{ position:fixed; inset:0; z-index:60; pointer-events:none; opacity:0;
      background:
        radial-gradient(1200px 600px at 70% -10%, rgba(147,197,253,0.18), transparent 60%),
        radial-gradient(800px 400px at 10% 110%, rgba(248,113,113,0.16), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,0.85), rgba(2,6,23,0.95));
      clip-path: circle(var(--r, 0px) at var(--cx, 50%) var(--cy, 50%));
      transition: clip-path 720ms cubic-bezier(.22,.9,.23,1), opacity 180ms ease; }
    #dream-reveal.active{ opacity:1; }
</style>
  
</head>
<body data-mode="intro">
  <!-- Fullscreen starfield background -->
  <canvas id="space"></canvas>
  <div class="bg-overlay" aria-hidden="true"></div>

  <!-- Page content -->
  <header id="site-header" class="site" hidden>
    <div class="page nav">
      <div class="brand">Starry profile </div>
      <nav class="links" aria-label="Primary">
        <a href="#about">About</a>
        <a href="#skills">Skills</a>
        <a href="#projects">Projects</a>
        <a href="#contact">Contact</a>
        <a href="#" id="sleep-link" title="Return to Dream">Sleep</a>
      </nav>
    </div>
  </header>

  <!-- =================== INTRO (start screen) =================== -->
    <section id="intro">
    <div class="intro-wrap">
      <div class="intro-card">
        <h2 style="color:#fff; margin-bottom:10px;">Dreaming…</h2>
        <div class="sleep-stage">
          <div class="bed"></div>
          <div class="blanket"></div>
          <div class="pillow"></div>
          <div class="sleeper"></div>
          <div class="zzz"><span>Z</span><span>Z</span><span>Z</span></div>

          <div class="dream-window" aria-hidden="true">
            <canvas id="dream-sky"></canvas>
          </div>

          <button id="enter-site" class="enter-btn" type="button">Enter Dream →</button>
        </div>
      </div>
    </div>
  </section>

  <main id="site-main" class="page" hidden>
    <section aria-labelledby="profile-title">
      <div class="card hero">
        <div class="avatar" aria-hidden="true">
          <img src="https://image2url.com/images/1756452847533-bbaebd6c-4e39-43d8-8654-212ddf1e8f69.jpg" alt="profile" />
        </div>
        <div>
          <h1 id="profile-title">Hi, I'm <strong> Starry (Yu Jiang)</strong></h1>
          <p class="muted"> University of New South Wales (UNSW)</p>
          <br>
            <p class="muted">Languages:  Javascript, Typescript,  </p>
            <p class="muted">Frameworks: Node.js, python, Mongodb, FastAPI</p>
            <p class="muted">Tools:      Git, Docker, Postgresql, Vercel</p>
          <div class="row" style="margin-top:12px">
            <a class="btn" href="#projects">View Projects</a>
            <a class="btn" href="#contact">Get in Touch</a>
          </div>
          <h3 class="muted" style="margin-top:10px; font-size: 24px;"> play instructions: <h3\>
          <p class="muted" style="margin-top:10px; font-size: 12px;">Scroll, or use your mouse wheel to change star speed (<span class="hint-motion">motion</span>)</p>
          <p class="muted" style="margin-top:10px; font-size: 12px;">Single click = Touch your wife's body</p>
          <p class="muted" style="margin-top:10px; font-size: 12px;">Double click = You can get a cute cat</p>
          <p class="muted" style="margin-top:10px; font-size: 12px;">Right click = Touch your wife's head</p>
          <p class="muted" style="margin-top:10px; font-size: 12px;"> Loops1: sleep</p> 
          <p class="muted" style="margin-top:10px; font-size: 12px;"> Loops2: ↔ fan ↔ finger</p>
        </div>
      </div>
    </section>
    <section id="about" aria-labelledby="about-title">
      <div class="card">
        <h2 id="about-title">About me</h2>
        <p class="muted">
            I build this for devsoc enrollment.</p>
      </div>
    </section>

    <section id="skills" aria-labelledby="skills-title">
      <div class="card">
        <h2 id="skills-title">Skills</h2>
        <div class="chips">
          <span class="chip">HTML</span>
          <span class="chip">CSS / Tailwind</span>
          <span class="chip">JavaScript</span>
          <span class="chip">Typescript</span>
          <span class="chip">Postgresql</span>
          <span class="chip">GitHub</span>

          <span class="chip">C/C++</span>
          <span class="chip">Java</span>
          <span class="chip">Python</span>
          <span class="chip">Docker</span>
          <span class="chip">Vercel</span>
          <span class="chip">GitHub</span>
        </div>
      </div>
    </section>

    <section id="projects" aria-labelledby="projects-title">
      <div class="card">
        <h2 id="projects-title">Projects</h2>
        <div class="projects">
        <article class="project">
        <h3>
            <a href="https://kahoot-bumar0g76-starrys-projects-829ce122.vercel.app/"
            target="_blank" rel="noopener noreferrer">
            Live Quiz Platform
            </a>
        </h3>
        <p>Developed a real-time quiz platform inspired by Kahoot using TypeScript, React, Node.js, and Socket.io</p>
        </article>

        <article class="project">
        <h3>
            <a href="https://questioner-pi86.vercel.app/"
            target="_blank" rel="noopener noreferrer">
            Questioner
            </a>
        </h3>
        <p>Paste a YouTube video link and adaptive related test.</p>
        </article>


        </div>
      </div>
    </section>

    <section id="contact" aria-labelledby="contact-title">
      <div class="card">
        <h2 id="contact-title">Contact</h2>
        <p class="muted">
        Email: <a href="z5564122@ad.unsw.edu.au" style="color:#93c5fd">z5564122@ad.unsw.edu.au</a> 
        · GitHub: <a href="https://github.com/Starry1513" target="_blank" rel="noopener" style="color:#93c5fd">Starry1513</a></p>
        
      </div>
    </section>

    <footer>
      © <span id="year"></span> Starry front‑ends· Built with HTML, CSS & a sprinkle of Canvas ✨
    </footer>
  </main>
  

  <script>
    // ======= Starfield Background (optimized & beginner-friendly) =======
    const canvas = document.getElementById('space');
    const ctx = canvas.getContext('2d');

    const cfg = {
      focalLength: 400,       // Focal length (updated based on screen size in resize())
      mouseInfluence: 0.22,   // Mouse influence coefficient
      speed: 1.0,             // Base speed, adjustable with scroll wheel
      maxStarSize: 8,       // Maximum star radius
      fadeStartZ: 220,        // Distance where fading starts
      fadeEndZ: 90            // Distance where completely disappears
    };

    let stars = [];
    let cx = 0, cy = 0;      // Canvas center (in pixels)
    let mx = 0, my = 0;      // Mouse offset relative to center

    function createStars(count) {
      stars = Array.from({ length: count }, () => ({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        z: Math.random() * canvas.width,
        o: 0.6 + Math.random() * 0.4, // Opacity 0.3~1.0
        px: 0, py: 0, pz: 0           // Previous frame coordinates (for trails)
      }));
    }

    function resize() {
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const w = Math.floor(window.innerWidth * dpr);
      const h = Math.floor(window.innerHeight * dpr);
      canvas.width = w; canvas.height = h;
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
      cx = w / 2; cy = h / 2;
      cfg.focalLength = Math.min(w, h) * 0.9; // Update focal length based on canvas

      // Adaptive quantity: density (one star per 2,200 pixels), limited between 800~4000
      const density = 800;
      const target = Math.max(800, Math.min(4000, Math.floor((w * h) / density)));
      createStars(target);
    }

    function pos(x, y, z) {
      const scale = cfg.focalLength / z;
      return {
        x: (x - cx) * scale + cx,
        y: (y - cy) * scale + cy,
        r: Math.min(cfg.maxStarSize, scale) // Radius
      };
    }

    function alpha(z) {
      if (z <= cfg.fadeStartZ) {
        return Math.max(0, Math.min(1, (z - cfg.fadeEndZ) / (cfg.fadeStartZ - cfg.fadeEndZ)));
      }
      return 1;
    }

    function move() {
      const len = stars.length;
      for (let i = 0; i < len; i++) {
        const s = stars[i];
        // Save previous frame
        s.px = s.x; s.py = s.y; s.pz = s.z;
        // Move towards observer
        s.z -= cfg.speed;
        // Mouse micro-offset (decreases with z)
        s.x += (mx * cfg.mouseInfluence) / Math.max(60, s.z);
        s.y += (my * cfg.mouseInfluence) / Math.max(60, s.z);

        // Reset (return to far distance after passing through lens)
        if (s.z <= cfg.fadeEndZ) {
          s.z = canvas.width;
          s.x = Math.random() * canvas.width;
          s.y = Math.random() * canvas.height;
          s.px = s.x; s.py = s.y; s.pz = s.z;
        }
      }
    }

    function draw() {
      // Background clear
      ctx.fillStyle = 'rgb(0,10,20)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const fast = cfg.speed > 10; // Draw trails only at high speed
      const len = stars.length;
      for (let i = 0; i < len; i++) {
        const s = stars[i];
        const curr = pos(s.x, s.y, s.z);
        const a = alpha(s.z) * s.o;

        if (fast) {
          const prev = pos(s.px, s.py, s.pz);
          ctx.beginPath();
          ctx.moveTo(prev.x, prev.y);
          ctx.lineTo(curr.x, curr.y);
          ctx.strokeStyle = `rgba(255,255,255,${0.28 * a})`;
          ctx.lineWidth = curr.r;
          ctx.stroke();
        }

        ctx.beginPath();
        ctx.arc(curr.x, curr.y, curr.r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255,255,255,${a})`;
        ctx.fill();
      }
    }

    function loop() {
      move();
      draw();
      requestAnimationFrame(loop);
    }

    // Events
    window.addEventListener('resize', resize);
    document.addEventListener('mousemove', (e) => { mx = (e.clientX * (window.devicePixelRatio || 1)) - cx; my = (e.clientY * (window.devicePixelRatio || 1)) - cy; });
    document.addEventListener('wheel', (e) => {
      cfg.speed = Math.max(0.1, Math.min(50, cfg.speed - e.deltaY * 0.01));
    }, { passive: true });

    // Init
    resize();
    loop();

    // Footer year
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>

<script>
// ===== Return to Dream (Sleep) =====
function goToDream(){
  // show intro again
  const intro = document.getElementById('intro');
  if(!intro) return;
  intro.classList.remove('fade-out');
  intro.style.display = '';
  // set mode to intro so overlay disappears and backgrounds go transparent
  document.body.dataset.mode = 'intro';
  // hide site chrome & live2d
  const siteHeader = document.getElementById('site-header');
  const mainSite = document.getElementById('site-main');
  if(siteHeader) siteHeader.hidden = true;
  if(mainSite) mainSite.hidden = true;
  window.L2D
  console.log("gotoDream")
  window.L2D.requestLoop('main'); 

  // slow down starfield a bit for calm vibe
  try { cfg.speed = Math.min(cfg.speed, 4); cfg.speed = Math.max(0.8, cfg.speed - 1.5); } catch(e){}
  // scroll top for consistent framing
  window.scrollTo({ top: 0, behavior: 'smooth' });
}


</script>

<!-- Place before </body>; container above script -->
  <div id="l2d-container" style="position:fixed;right:10px;bottom:10px;z-index:9;"></div>


<!-- Pixi v6 (matches plugin; don't use v7) -->
<script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.8/dist/browser/pixi.min.js"></script>

<!-- Cubism Core (required for Cubism3/4) -->
<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>

<!-- pixi-live2d-display: use unlocked version or pin to 0.4.0 (choose one of the two methods) -->
<!-- Recommended unlocked version (follows latest 0.4.0 documentation): -->
<script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/cubism4.min.js"></script>
<!-- Or fixed 0.4.0: -->
<!-- <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script> -->
<!-- Backup source (if jsDelivr is slow): https://unpkg.com/pixi-live2d-display@0.4.0/dist/cubism4.min.js -->

<script>


window.L2D = window.L2D || { inited:false, app:null, model:null, fit:null, setLoop:null, _pendingLoop:null };


function requestLoop(name){
  const L = window.L2D;
  if (L.inited && typeof L.setLoop === 'function') {
    L.setLoop(name, true);       
  } else {
    L._pendingLoop = name;    
  }
}
window.L2D.requestLoop = requestLoop;

async function initLive2D() {
  if (window.L2D.inited) return;
  if (!window.PIXI || !PIXI.live2d || !PIXI.live2d.Live2DModel) {
    console.error('PIXI / pixi-live2d-display not loaded');
    return;
  }

  const host = document.getElementById('l2d-container');
  if (!host) return;

  host.style.display = 'block';

  const app = new PIXI.Application({
    backgroundAlpha: 0,
    antialias: true,
    autoDensity: true,
    resolution: Math.min(window.devicePixelRatio || 1, 2),
    resizeTo: host
  });
  host.appendChild(app.view);

  const MODEL_URL = './lafei_4/lafei_4.model3.json';
  const model = await PIXI.live2d.Live2DModel.from(MODEL_URL);
  app.stage.addChild(model);
  model.anchor.set(0.5, 1);

  function fit(){
    const w = host.clientWidth || 300;
    const h = host.clientHeight || 360;
    model.scale.set(1);
    const s = Math.min((w-16)/model.width, (h-16)/model.height);
    model.scale.set(s);
    model.x = w * 0.5 +90;
    model.y = h - 180;
  }
  fit();

    
  const mm = model.internalModel.motionManager;

  const loops = {
    sleep: [ ['Main', 2] ],
    login: [ ['Login', 0], ['Main', 2]],
    complete: [ ['Complete', 0] ],                 
    main:  [ ['Main', 0], ['Main', 1] ],   
    email:  [ ['Email', 0] ],
    main2:   [ ['Main', 1] ],
    mission:  [ ['Mission', 0] ],
  };

  let currentLoop = 'sleep';
  let idx = 0;

  function playNext(){
    const [group, index] = loops[currentLoop][idx];
    try { model.motion(group, index); } catch(e){}
    idx = (idx + 1) % loops[currentLoop].length;
  }

  function setLoop(name, immediate = true){
    if (!loops[name]) return;
    currentLoop = name;
    idx = 0;
    try { if (typeof mm.stopAllMotions === 'function') mm.stopAllMotions(); } catch(e){}
    if (immediate) playNext();
  }


  app.ticker.add(() => {
    const stopped = (typeof mm.isFinished === 'function') ? mm.isFinished() : !mm.isPlaying;
    if (stopped) playNext();
  });


  window.L2D.inited = true;
  window.L2D.app = app;
  window.L2D.model = model;
  window.L2D.fit = fit;
  window.L2D.setLoop = setLoop;
  window.L2D.requestLoop = requestLoop;
  if (window.L2D._pendingLoop) {
    setLoop(window.L2D._pendingLoop, true);
    window.L2D._pendingLoop = null;
  } else {
    console.log('login action start');
    setLoop('login', true);
  }

    // window.L2D.requestLoop('sleep');

    // loop display
    // app.ticker.add(() => {
    //   const stopped = (typeof mm.isFinished === 'function') ? mm.isFinished() : !mm.isPlaying;
    //   if (stopped) {
    //     playNextInOrder(1);
    //     // model.motion('Main', 2);
    //   }
    // });


  let singleTimer = null;
  const SINGLE_DELAY = 220;
  function forceClick(groupOrAlias, index) {
    const mm = model.internalModel.motionManager;
    if (typeof mm.stopAllMotions === 'function') mm.stopAllMotions();
    if (index !== undefined) {
      console.log('[play] ', groupOrAlias);
      model.motion(groupOrAlias, index);   // example ('Main', 0)
    } else {
      model.motion(groupOrAlias);          // example ('TapBody') / ('TapSpecial') / ('TapHead')
    }
  }

  app.view.addEventListener('click', () => {
    clearTimeout(singleTimer);
    singleTimer = setTimeout(() => {
      forceClick('TapBody'); 
    }, SINGLE_DELAY);
  });


  app.view.addEventListener('dblclick', () => {
    clearTimeout(singleTimer);
    singleTimer = null;
    forceClick('TapSpecial');  //  TapSpecial
  });

  app.view.addEventListener('contextmenu', () => {
    clearTimeout(singleTimer);
    singleTimer = null;
    forceClick('TapHead');  
  });

  const ro = new ResizeObserver(()=> fit());
  ro.observe(host);
  window.addEventListener('resize', fit);
}



function showLive2D(){
  const host = document.getElementById('l2d-container');
  if (!host) return;
  if (!L2D.inited) {
    initLive2D();
  } else {
    host.style.display = 'block';
    requestAnimationFrame(()=> L2D.fit && L2D.fit());
  }
}
</script>


<script>
  // ===== Dream portal interactions =====
  const portal = document.getElementById('dream-portal');
  const closeBtn = document.getElementById('close-dream');

  function openDream(){
    overlay.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden'; // prevent background scroll
    // optional: accelerate stars a bit for a warp effect
    try { window.__oldSpeed = cfg.speed; cfg.speed = Math.min(20, cfg.speed + 6); } catch (e){}
  }
  function closeDream(){
    overlay.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    try { if (typeof window.__oldSpeed === 'number') cfg.speed = window.__oldSpeed; } catch (e){}
    // focus back for accessibility
    portal.focus();
  }

  portal?.addEventListener('click', openDream);
  closeBtn?.addEventListener('click', closeDream);
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && overlay.getAttribute('aria-hidden') === 'false'){ closeDream(); }});
</script>

<script>
// ===== Small starfield inside the dream window (beginner friendly) =====
(function(){
  const c = document.getElementById('dream-sky');
  if(!c) return;
  const x = c.getContext('2d');
  let w, h, dpr;
  let stars = [];
  function resize(){
    dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    const rect = c.parentElement.getBoundingClientRect();
    w = Math.floor(rect.width * dpr); h = Math.floor(rect.height * dpr);
    c.width = w; c.height = h; c.style.width = rect.width + 'px'; c.style.height = rect.height + 'px';
    stars = Array.from({length: 80}, ()=>({
      x: Math.random()*w,
      y: Math.random()*h,
      r: Math.random()*1.8 + 0.4,
      t: Math.random()*Math.PI*2
    }));
  }
  function draw(){
    x.fillStyle = 'rgb(3,8,23)';
    x.fillRect(0,0,w,h);
    for(const s of stars){
      s.t += 0.04;
      const a = 0.5 + Math.sin(s.t)*0.5; // twinkle
      x.beginPath();
      x.arc(s.x, s.y, s.r, 0, Math.PI*2);
      x.fillStyle = 'rgba(255,255,255,'+a.toFixed(2)+')';
      x.fill();
    }
    requestAnimationFrame(draw);
  }
  window.addEventListener('resize', resize);
  resize(); draw();
})();

// ===== Enter -> hide intro, show main, (optionally) boost background stars =====
const intro = document.getElementById('intro');
const mainSite = document.getElementById('site-main');
const siteHeader = document.getElementById('site-header');
const l2d = document.getElementById('l2d-container');
const sleepLink = document.getElementById('sleep-link');
const enterBtn = document.getElementById('enter-site');
const introDreamWindow = document.querySelector('#intro .dream-window');

// // Bind Sleep nav here so variable is defined
sleepLink?.addEventListener('click', (e)=>{ e.preventDefault(); goToDream(); });
</script>

<script>

const aboutLinks   = document.querySelectorAll('a[href="#about"]');
const contactLinks = document.querySelectorAll('a[href="#contact"]');
const skillsLinks  = document.querySelectorAll('a[href="#skills"]');
const projectsLinks  = document.querySelectorAll('a[href="#projects"]');

function enterMainThen(loopName, targetId) {

  const intro = document.getElementById('intro');
  const siteHeader = document.getElementById('site-header');
  const mainSite = document.getElementById('site-main');
  const introDreamWindow = document.querySelector('#intro .dream-window');

  const go = () => {
    try { window.L2D && window.L2D.requestLoop && window.L2D.requestLoop(loopName); } catch(e){}
    const sec = document.getElementById(targetId);
    sec && sec.scrollIntoView({ behavior: 'smooth', block: 'start' });
    try { cfg.speed = Math.max(cfg.speed, 4); } catch(e){}
  };


  if (document.body.dataset.mode === 'main') {
    go(); 
    return;
  }

  DreamFX.revealFrom(introDreamWindow, () => {
    intro.classList.add('fade-out');
    setTimeout(() => {
      intro.style.display = 'none';
      document.body.dataset.mode = 'main';
      siteHeader.hidden = false;
      mainSite.hidden = false;

      requestAnimationFrame(() => requestAnimationFrame(go));
    }, 10);
  });
}

// About -> complete loop
aboutLinks.forEach(a => {
  a.addEventListener('click', (e) => {
    e.preventDefault();
    enterMainThen('complete', 'about');
  });
});

// Contact -> email loop
contactLinks.forEach(a => {
  a.addEventListener('click', (e) => {
    e.preventDefault();
    enterMainThen('email', 'contact');
  });
});

// Contact -> skills loop
skillsLinks.forEach(a => {
  a.addEventListener('click', (e) => {
    e.preventDefault();
    enterMainThen('main2', 'skills');
  });
});


// Contact -> skills loop
projectsLinks.forEach(a => {
  a.addEventListener('click', (e) => {
    e.preventDefault();
    enterMainThen('mission', 'projects');
  });
});

</script>



<!-- Circular reveal overlay -->
<div id="dream-reveal" aria-hidden="true"></div>

<script>  
// ===== Helpers for circular reveal / conceal =====
(function(){
  function radiusToCover(cx, cy){
    const w = window.innerWidth, h = window.innerHeight;
    const dx = Math.max(cx, w - cx);
    const dy = Math.max(cy, h - cy);
    return Math.hypot(dx, dy);
  }
  function setCenter(overlay, cx, cy){
    overlay.style.setProperty('--cx', cx + 'px');
    overlay.style.setProperty('--cy', cy + 'px');
  }
  window.DreamFX = {
    revealFrom(el, done){
      const overlay = document.getElementById('dream-reveal');
      if(!overlay || !el) return done?.();
      const r = el.getBoundingClientRect();
      const cx = r.left + r.width/2; const cy = r.top + r.height/2;
      setCenter(overlay, cx, cy);
      overlay.style.setProperty('--r', '0px');
      overlay.classList.add('active');
      overlay.style.clipPath = `circle(0px at ${cx}px ${cy}px)`;
      requestAnimationFrame(()=>{
        const R = radiusToCover(cx, cy);
        overlay.style.clipPath = `circle(${R}px at ${cx}px ${cy}px)`;
        setTimeout(()=>{ overlay.classList.remove('active'); done?.(); }, 760);
      });
    },
    concealTo(el, done){
      const overlay = document.getElementById('dream-reveal');
      if(!overlay || !el) return done?.();
      const r = el.getBoundingClientRect();
      const cx = r.left + r.width/2; const cy = r.top + r.height/2;
      const R = radiusToCover(cx, cy);
      setCenter(overlay, cx, cy);
      overlay.classList.add('active');
      overlay.style.clipPath = `circle(${R}px at ${cx}px ${cy}px)`;
      requestAnimationFrame(()=>{
        overlay.style.clipPath = `circle(0px at ${cx}px ${cy}px)`;
        setTimeout(()=>{ overlay.classList.remove('active'); done?.(); }, 760);
      });
    }
  };
})();
</script>

<script>
// ===== Wire the transitions into enter / sleep flows =====
(function(){
  const intro = document.getElementById('intro');
  const siteHeader = document.getElementById('site-header');
  const mainSite = document.getElementById('site-main');
  const l2d = document.getElementById('l2d-container');
  const introDreamWindow = document.querySelector('#intro .dream-window');
  const enterBtn = document.getElementById('enter-site');
  const sleepLink = document.getElementById('sleep-link');

  function doEnter(){
    // Play reveal from the intro dream window, then show main
    DreamFX.revealFrom(introDreamWindow, ()=>{
      intro.classList.add('fade-out');
      setTimeout(()=>{
        intro.style.display='none';
        document.body.dataset.mode = 'main';
        siteHeader.hidden = false; mainSite.hidden = false;
        window.L2D
        console.log("doEnter")
        window.L2D.requestLoop('main'); 

        try { cfg.speed = Math.max(cfg.speed, 4); } catch(e){}
      }, 10);
    });
  }

  function doSleep(){
    // First show intro so we can measure its dream window, but keep UI as is for one frame
    intro.style.display='';
    document.body.dataset.mode = 'intro';
    requestAnimationFrame(()=>{
      DreamFX.concealTo(introDreamWindow, ()=>{
        // After contraction, hide site chrome
        siteHeader.hidden = true; mainSite.hidden = true;
        window.L2D
        console.log("doSleep")
        window.L2D.requestLoop('sleep'); 
        window.scrollTo({ top: 0, behavior: 'smooth' });
        try { cfg.speed = Math.min(cfg.speed, 4); cfg.speed = Math.max(0.8, cfg.speed - 1.5); } catch(e){}
      });
    });
  }

  enterBtn?.addEventListener('click', doEnter);
  introDreamWindow?.addEventListener('click', doEnter);
  sleepLink?.addEventListener('click', (e)=>{ e.preventDefault(); doSleep(); });
})();
</script>
<script>
  function waitUntilVisible(el){
    return new Promise(resolve=>{
      const tick=()=>{ 
        const r=el.getBoundingClientRect();
        if(!el.hidden && r.width>0 && r.height>0) return resolve();
        requestAnimationFrame(tick);
      };
      tick();
    });
  }

  function waitLibs(){
    return new Promise(resolve=>{
      const tick=()=>{
        if (window.PIXI && PIXI.live2d && PIXI.live2d.Live2DModel) return resolve();
        requestAnimationFrame(tick);
      };
      tick();
    });
  }


  window.addEventListener('DOMContentLoaded', async () => {
    const host = document.getElementById('l2d-container');
    if (!host) return;
    host.style.display = 'block';
    await waitUntilVisible(host);
    await waitLibs();

    requestAnimationFrame(()=> requestAnimationFrame(()=> showLive2D()));
  });
</script>

</body>
</html>
